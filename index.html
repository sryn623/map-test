<!DOCTYPE html>
<html>

<head>
    <title>Geolocation with Leaflet</title>
    <!-- LEAFLET CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <!-- LEAFLET JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>
        // Initialize the map
        var map = L.map('map').setView([28.2380, 83.9956], 11);

        // Add OpenStreetMap tiles
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: 'Leaflet &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);

        // Taxi icon for marker
        var taxiIcon = L.icon({
            iconUrl: '/delivery.png',
            iconSize: [40, 40],
        });

        // Initialize marker with a default location
        var marker = L.marker([28.2380, 83.9956], { icon: taxiIcon }).addTo(map);

        // Get user's current location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    var userLat = position.coords.latitude;
                    var userLng = position.coords.longitude;

                    // Update map view to user's location
                    map.setView([userLat, userLng], 13);

                    // Update the marker position to user's location
                    marker.setLatLng([userLat, userLng]);

                    // Add a popup to indicate user's location
                    marker.bindPopup("You are here!").openPopup();

                    // Handle map click for routing
                    map.on('click', function (e) {
                        var destinationLat = e.latlng.lat;
                        var destinationLng = e.latlng.lng;

                        // Add a new marker at the clicked location
                        var newMarker = L.marker([destinationLat, destinationLng]).addTo(map);

                        // Add routing control from user's location to clicked location
                        L.Routing.control({
                            waypoints: [
                                L.latLng(userLat, userLng),
                                L.latLng(destinationLat, destinationLng)
                            ]
                        }).on('routesfound', function (e) {
                            var routes = e.routes;
                            console.log(routes);

                            // Move the taxi marker along the route
                            e.routes[0].coordinates.forEach(function (coord, index) {
                                setTimeout(function () {
                                    marker.setLatLng([coord.lat, coord.lng]);
                                }, 100 * index);
                            });
                        }).addTo(map);
                    });
                },
                function (error) {
                    console.error("Error getting location: ", error.message);
                }
            );
        } else {
            alert("Geolocation is not supported by your browser.");
        }
    </script>
</body>

</html>
